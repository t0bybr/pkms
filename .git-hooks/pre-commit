#!/bin/bash
# PKMS Pre-commit Hook
# Validates files before allowing commit

set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "üîç PKMS Pre-commit validation..."

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any validation failed
VALIDATION_FAILED=0

# 1. Validate JSON files
echo "  ‚Üí Validating JSON files..."
JSON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.json$' || true)

if [ -n "$JSON_FILES" ]; then
    for file in $JSON_FILES; do
        if [ -f "$file" ]; then
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo -e "${RED}‚úó Invalid JSON: $file${NC}"
                VALIDATION_FAILED=1
            else
                echo -e "  ${GREEN}‚úì${NC} $file"
            fi
        fi
    done
else
    echo "  (no JSON files staged)"
fi

# 2. Validate TOML files
echo "  ‚Üí Validating TOML files..."
TOML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.toml$' || true)

if [ -n "$TOML_FILES" ]; then
    for file in $TOML_FILES; do
        if [ -f "$file" ]; then
            if ! python3 -c "import tomli; tomli.load(open('$file', 'rb'))" 2>/dev/null; then
                # Fallback to toml if tomli not available
                if ! python3 -c "import toml; toml.load('$file')" 2>/dev/null; then
                    echo -e "${RED}‚úó Invalid TOML: $file${NC}"
                    VALIDATION_FAILED=1
                else
                    echo -e "  ${GREEN}‚úì${NC} $file"
                fi
            else
                echo -e "  ${GREEN}‚úì${NC} $file"
            fi
        fi
    done
else
    echo "  (no TOML files staged)"
fi

# 3. Validate taxonomy structure if taxonomy.toml changed
if echo "$TOML_FILES" | grep -q "taxonomy.toml"; then
    echo "  ‚Üí Validating taxonomy structure..."
    if [ -f ".pkms/taxonomy.toml" ]; then
        # Check required sections exist
        if ! grep -q '\[taxonomy.categories\]' .pkms/taxonomy.toml; then
            echo -e "${RED}‚úó Missing [taxonomy.categories] section${NC}"
            VALIDATION_FAILED=1
        fi
        if ! grep -q '\[taxonomy.tags\]' .pkms/taxonomy.toml; then
            echo -e "${RED}‚úó Missing [taxonomy.tags] section${NC}"
            VALIDATION_FAILED=1
        fi

        if [ $VALIDATION_FAILED -eq 0 ]; then
            echo -e "  ${GREEN}‚úì${NC} Taxonomy structure valid"
        fi
    fi
fi

# 4. Check for broken wikilinks in markdown files
MARKDOWN_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^vault/.*\.md$' || true)

if [ -n "$MARKDOWN_FILES" ]; then
    echo "  ‚Üí Checking wikilinks (warnings only)..."

    # Only warn, don't block commit
    if command -v pkms-link &> /dev/null; then
        if ! pkms-link --validate --quiet 2>/dev/null; then
            echo -e "${YELLOW}‚ö† Some wikilinks may be broken. Run 'pkms-link --validate' to check.${NC}"
        fi
    else
        echo "  (pkms-link not available, skipping)"
    fi
fi

# 5. Ensure no secrets in .env files
echo "  ‚Üí Checking for secrets..."
ENV_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.env' || true)

if [ -n "$ENV_FILES" ]; then
    echo -e "${RED}‚úó Attempting to commit .env file: $ENV_FILES${NC}"
    echo -e "${YELLOW}  .env files should be gitignored!${NC}"
    VALIDATION_FAILED=1
fi

# Final result
echo ""
if [ $VALIDATION_FAILED -eq 1 ]; then
    echo -e "${RED}‚ùå Pre-commit validation FAILED${NC}"
    echo "Fix the errors above and try again."
    exit 1
else
    echo -e "${GREEN}‚úÖ Pre-commit validation PASSED${NC}"
    exit 0
fi
