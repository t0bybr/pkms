version: "3.9"

services:
  # Base image with shared dependencies (built first)
  base:
    build:
      context: .
      dockerfile: Dockerfile.base
    image: pkms-base:latest
    command: /bin/true
    restart: "no"

  ollama:
    image: ollama/ollama:latest
    ports: ["11434:11434"]
    environment:
      - OLLAMA_KEEP_ALIVE=5m
    volumes:
      - ${MODELS:-/pkms/models}/llm:/root/.ollama:U
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 12g
        reservations:
          memory: 4g

  qwen-vl-ocr:
    build: ./services/qwen-vl-ocr
    command: ["python","app.py","--host","0.0.0.0","--port","8001"]
    ports: ["127.0.0.1:8001:8001"]
    volumes:
      - ${MODELS:-/pkms/models}/ocr:/models:U
      - ${DATA:-/pkms/data}:/data:U
    environment:
      - API_KEY=${API_KEY:-change_me_local_only}
      - QWEN_MODEL=Qwen/Qwen2.5-VL-7B-Instruct
      - HOME=/models
      - HF_HOME=/models/huggingface
      - TRANSFORMERS_CACHE=/models/huggingface
    user: "1000:1000"
    # network_mode: none
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 16g
        reservations:
          memory: 8g

  layout-detector:
    build: ./services/layout-detector
    command: ["python","app.py","--host","0.0.0.0","--port","8002"]
    ports: ["127.0.0.1:8002:8002"]
    volumes:
      - ${MODELS:-/pkms/models}/layout:/models:U
    environment:
      - API_KEY=${API_KEY:-change_me_local_only}
      - WEIGHTS_PATH=/models/doclaynet.pt
      - MPLCONFIGDIR=/tmp/matplotlib
      - YOLO_CONFIG_DIR=/tmp/Ultralytics
    user: "1000:1000"
    # network_mode: none
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4g
        reservations:
          memory: 2g

  clip-embed:
    build: ./services/clip-embed
    command: ["python","app.py","--host","0.0.0.0","--port","8003"]
    ports: ["127.0.0.1:8003:8003"]
    volumes:
      - ${MODELS:-/pkms/models}/clip:/models:U
    environment:
      - API_KEY=${API_KEY:-change_me_local_only}
      - CLIP_MODEL=ViT-L-14
      - CLIP_PRETRAINED=openai
      - HOME=/models
      - HF_HOME=/models/huggingface
      - TRANSFORMERS_CACHE=/models/huggingface
      - TORCH_HOME=/models/torch
    user: "1000:1000"
    # network_mode: none
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8g
        reservations:
          memory: 4g

  speech-to-text:
    build: ./services/speech-to-text
    command: ["python","app.py","--host","0.0.0.0","--port","8004"]
    ports: ["127.0.0.1:8004:8004"]
    volumes:
      - ${MODELS:-/pkms/models}/stt:/models:U
    environment:
      - API_KEY=${API_KEY:-change_me_local_only}
      - WHISPER_CACHE=/models
    user: "1000:1000"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8g
        reservations:
          memory: 4g

  ingest-worker:
    build: ./services/ingest_worker
    environment:
      - API_KEY=${API_KEY:-change_me_local_only}
      - QWEN_URL=http://qwen-vl-ocr:8001
      - LAYOUT_URL=http://layout-detector:8002
      - CLIP_URL=http://clip-embed:8003
      - STT_URL=http://speech-to-text:8004
      - INDEX_DIR=/app/index
      - DATA_DIR=/app/data
      - HF_HOME=/app/models/huggingface
      - TRANSFORMERS_CACHE=/app/models/huggingface
      - SENTENCE_TRANSFORMERS_HOME=/app/models/sentence-transformers
    volumes:
      - ${DATA:-/pkms/data}:/app/data:U
      - ${INDEX:-/pkms/index}:/app/index:U
      - ${MODELS:-/pkms/models}:/app/models:U
    user: "1000:1000"
    depends_on:
      - qwen-vl-ocr
      - layout-detector
      - clip-embed
      - speech-to-text
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4g
        reservations:
          memory: 2g

  redis:
    image: redis:7-alpine
    user: "1000:1000"
    restart: unless-stopped
    volumes:
      - redis_data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    command: ["redis-server","--save","","--appendonly","no","--requirepass","${REDIS_PASSWORD:-}"]
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || redis-cli -a \"$REDIS_PASSWORD\" ping"]
      interval: 30s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512m
        reservations:
          memory: 256m

  rag-api:
    build: ./services/rag-api
    ports: ["127.0.0.1:8080:8080"]
    environment:
      - OLLAMA_URL=http://ollama:11434
      - CLIP_URL=http://clip-embed:8003
      - INDEX_DIR=/app/index
      - DATA_DIR=/app/data
      - API_KEY=${API_KEY:-change_me_local_only}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - HF_HOME=/app/models/huggingface
      - TRANSFORMERS_CACHE=/app/models/huggingface
      - SENTENCE_TRANSFORMERS_HOME=/app/models/sentence-transformers
    volumes:
      - ${INDEX:-/pkms/index}:/app/index:ro,U
      - ${DATA:-/pkms/data}:/app/data:ro,U
      - ${MODELS:-/pkms/models}:/app/models:U
    user: "1000:1000"
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4g
        reservations:
          memory: 2g

  dashboard:
    image: nginx:alpine
    ports: ["127.0.0.1:3000:80"]
    volumes:
      - ./services/dashboard:/usr/share/nginx/html:ro,z
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256m
        reservations:
          memory: 128m

  backup:
    build: ./services/backup
    environment:
      - RESTIC_REPO=/backups/pkms
      - RESTIC_PASSWORD=${RESTIC_PASSWORD:-change_me}
      - RESTIC_INCLUDE_DATA=/data
      - RESTIC_INCLUDE_INDEX=/index
    volumes:
      - ${DATA:-/pkms/data}:/data:ro,U
      - ${INDEX:-/pkms/index}:/index:ro,U
      - ${BACKUPS:-/pkms/backups}:/backups:U
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512m
        reservations:
          memory: 256m

volumes:
  redis_data:
